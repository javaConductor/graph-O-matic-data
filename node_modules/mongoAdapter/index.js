/**
 * Created with JetBrains WebStorm.
 * User: lee
 * Date: 6/20/13
 * Time: 1:58 PM
 */

(function (wu, mongoose, model, extend, logger, q) {
    var beforeSaveDefault = function (x) {
        x = x || {};
        if (x && x.id){
            x._id = x.id;
            x.id = undefined;
        }
        return x;
    };

    var afterReadDefault = function (x) {
        x = x  || {};
        if( x.toObject )
            x =  x.toObject();
        x.id = x._id;
        x._id = undefined;
        return x;
    };

    var afterReadType = function(x){
        x.origin = x._origin[0];
        x._origin = undefined;
        return x;
    };
    var beforeSaveType = function(x){
        if(x)
            x._origin = [x.origin];
        x.origin = undefined;
        return x;
    };

    var afterReadView = function(v){
        if(v.data)
            v.data.items = v.data.items.map(function(viewItem){
               viewItem.item = afterRead.item(viewItem.item);
                return viewItem;
            });

        v.summary = v.summary[0];

        if (v.options){
            v.viewOptions = v.options;
            v.options = undefined;
        }
        return v;
    };

    var beforeSaveView = function(v){

        if(v.data)
            v.data.items = v.data.items.map(function(viewItem){
                viewItem.item = beforeSave.item(viewItem.item);
                return viewItem;
            });

        v.summary = [v.summary];

        if (v.viewOptions){
            v.options = v.viewOptions;
            v.viewOptions = undefined;
        }
        return v;
    };

    var identity = function (x) {
        return x;
    };

    var beforeSave = {
        viewSummary:beforeSaveDefault,
        view:wu.compose( beforeSaveView,beforeSaveDefault),
        item: beforeSaveDefault,
        viewItem: beforeSaveDefault,
        relationship:  beforeSaveDefault,

        category: wu.compose( beforeSaveType,beforeSaveDefault),
        itemType: wu.compose( beforeSaveType,beforeSaveDefault),
        relationshipType: wu.compose(  beforeSaveType,beforeSaveDefault),
        viewType: wu.compose(  beforeSaveType,beforeSaveDefault),

        context: identity,
        "*": identity
    };
    var afterRead = {
        viewSummary: afterReadDefault,
        view: wu.compose( afterReadView, afterReadDefault),
        item:(afterReadDefault),
        viewItem: afterReadDefault,
        relationship: afterReadDefault,
        category: wu.compose( afterReadType, afterReadDefault),
        itemType:  wu.compose( afterReadType, afterReadDefault),
        relationshipType:  wu.compose(afterReadType, afterReadDefault),
        viewType:  wu.compose( afterReadType, afterReadDefault),

        context: identity,
        "*": identity
    };

    this.debug = function (txt) {
        txt = txt || "";
        logger.debug("Debug: " + txt);
    };
    this.log = logger.debug;
    this.error = logger.error;

    var self = this;
    //////  Category //////
    //////  Category //////
    this.saveCategory = function (rcat) {
        var d = q.defer();
        rcat = beforeSave.category(rcat);
        logger.debug("mongoAdapter.saveCategory(" + rcat + ")");
        var relCat = new model.Category(rcat);
        relCat.save(function (err, cat) {
            return  (err) ? d.reject(err) : d.resolve( afterRead.category(cat));
        });
        return d.promise;
    };

    this.getCategories = function () {
        var d = q.defer();
        model.getCategories
            .find({})
            .exec(function (err, cats) {
                return  (err) ? d.reject(err) : d.resolve( cats.map(afterRead.category));
            });
        return d.promise;
    };

    ////////  Relationship Type ////////
    ////////  Relationship Type ////////
    this.saveRelationshipType = function (rtype) {
        var d= q.defer();
        rtype = beforeSave.relationshipType(rtype);
        var relType = new model.RelationshipType(rtype);
        relType.save(function (e, rt) {
            return (e) ? d.reject(e) : d.resolve(afterRead.relationshipType(rt));
        });
        return d.promise;
    };

    this.updateRelationshipType = function (rtype) {
        var d= q.defer();
        logger.debug("mongoAdapter.updateRelationshipType(" + JSON.stringify(rtype) + ")");
        rtype = beforeSave.relationshipType(rtype);
        model.RelationshipType.findOneAndUpdate({ _id: rtype._id }, o, {new: false})
            .exec(function (err, rt) {
                return (err) ? d.reject(err) : d.resolve(afterRead.relationshipType(rt));
            });
        return d.promise;
    };

    this.getRelationshipTypeById = function (rtypeId) {
        var d = q.defer();
        var rt = model.RelationshipType.findOne({id: rtypeId})
            .exec(function (err, rtype) {
                return  (err) ? d.reject(err) : d.resolve(afterRead.relationshipType(rtype));
            });
        return d.promise;
    };

    this.getRelationshipType = function (context, area, name) {
        var d = q.defer();
        var rt = model.RelationshipType.findOne({name: name, 'origin.context': context, 'origin.area': area})
            .exec(function (err, rtype) {
                return  (err) ? d.reject(err) : d.resolve(afterRead.relationshipType(rtype));
            });
        return d.promise;
    };

    this.getRelationshipTypes = function () {
        var d = q.defer();
        var rt = model.RelationshipType.find({})
            .exec(function (err, rtypes) {
                return  (err) ? d.reject(err) : d.resolve( rtypes.map(afterRead.relationshipType));
            });
        return d.promise;
    };

    //////  Category //////
    //////  Category //////
    this.saveCategory = function (icat) {
        var d = q.defer();
        icat = beforeSave.category(icat);
        var cat = new model.Category(icat);
        cat.save(function (err, saved) {
            err ? d.reject(err) : d.resolve(afterRead.category(saved));
        });
        return d.promise;
    };

    this.deleteCategory = function (catId) {
        var d = q.defer();
        model.Category.findOne({_id: catId})
            .remove(function(err,res){
                return (err) ? d.reject(err) : d.resolve(true);
            });
        return d.promise;
    };

    this.getCategory = function (icatId) {
        var d= q.defer();
        if ( !icatId ){
            throw new Error("Category ID required.");
        }
        model.Category
            .findOne({_id: (icatId)})
            .exec(function (err, iCat) {
                return  (err) ? d.reject(err) : d.resolve(afterRead.category(iCat));
            });
        return d.promise;
    };

    this.getCategories = function () {
        var d = q.defer();
        model.Category
            .find({})
            .exec(function (err, iCats) {
                return  (err) ? d.reject(err) : d.resolve( iCats.map(afterRead.category));
            });
        return d.promise;
    };

    ////// ViewType  //////
    //////  ViewType  //////
    this.saveViewType = function (it) {
        var d= q.defer();
        var viewType = new model.ViewType(beforeSave.viewType(it));
        viewType.save(function (err, saved) {
                return (err) ?  d.reject(err) : d.resolve( afterRead.viewType(saved));
        });
        return d.promise;
    };

    this.getViewType = function (vtypeId) {
        var d= q.defer();
        model.Item.findOne({id: vtypeId})
            .exec(function (err, vt) {
                return (err) ? d.reject(err) : d.resolve( afterRead.viewType(vt));
            });
        return d.promise;
    };

    this.getViewTypes = function () {
        var d = q.defer();
        model.ViewType.find({})
            .exec(function (err, saved) {
                return (err) ? d.reject(err) : d.resolve( (saved || []).map(afterRead.viewType));
            });
    return d.promise;
    };

    //////  ItemType  //////
    //////  ItemType  //////
    this.saveItemType = function (it) {
        logger.debug("mongoAdapter.saveItemType(" + JSON.stringify(it) + ")");
        var d = q.defer();
        it = beforeSave.itemType(it);
        var itemType = new model.ItemType(it);
        itemType.save(function (err, saved) {
            return (err) ? d.reject(err) : d.resolve( afterRead.itemType(saved));
        });
        return d.promise;
    };

    this.updateItemType = function (itype) {
        var d = q.defer();
        logger.debug("mongoAdapter.updateItemType(" + JSON.stringify(itype) + ")");
        itype = beforeSave.itemType(itype);
        itype.save(function (err, saved) {
            return (err) ? d.reject(err) : d.resolve( afterRead.itemType(saved));
        });
        return d.promise;
    };

    this.getItemTypeById = function (itypeId) {
        var d = q.defer();
        logger.debug("mongoAdapter.getItemTypeById(" + itypeId + ")");
        model.ItemType.findOne({_id: ( itypeId)})
            .exec(function (err, it) {
                return (err) ? d.reject(err) : d.resolve(afterRead.itemType(it));
            });
        return d.promise;
    };

    this.getItemType = function (context, area, name) {
        var d = q.defer();
        logger.debug("mongoAdapter.getItemType(" + context + "." + area + "." + name + ")");
        model.ItemType.findOne({'origin.context': context, 'origin.area': area, name: name})
            .exec(function (err, itype) {
                (err) ? d.reject(err) : d.resolve(afterRead.itemType(itype));
            });
    return d.promise;
    };

    this.getItemTypeByName = function (fullTypeName) {
        logger.debug("mongoAdapter.getItemTypeByName(" + fullTypeName + ")");
        var parts = fullTypeName.split(".", 3);
        var context, area, name;
        if (parts.length == 3) {
            context = parts[0];
            area = parts[1];
            name = parts[2];
        } else {
            context = "default";
            area = "common";
            name = fullTypeName;
        }
        this.getItemType(context, area, name);
    };

    this.getItemTypes = function () {
        var d = q.defer();
        logger.debug("mongoAdapter.getItemTypes()");
        model.ItemType.find({})
            .exec(function (err, itypes) {
                (err) ? d.reject(err) : d.resolve(itypes.map(afterRead.itemType));
            });
        return d.promise;
    };

    //////  Item  //////
    //////  Item  //////
    this.saveItem = function ( itmP  ) {
        var d= q.defer();
        q.when(itmP, function(itm){
            logger.debug("mongoAdapter.saveItem(" + JSON.stringify( itm ) + ")");
            //console.log("mongoAdapter.saveItem(" + JSON.stringify( itm ) + ")");
            itm = beforeSave.item( itm );
            //logger.debug("mongoAdapter.saveItem after filter(" + JSON.stringify( itm ) + ")");
            //console.log("mongoAdapter.saveItem after filter(" + JSON.stringify( itm ) + ")");
            var item = new model.Item( itm );
            logger.debug("mongoAdapter.saveItem as modelItem(" + JSON.stringify( item ) + ")");
           // console.log("mongoAdapter.saveItem as modelItem(" + JSON.stringify( item ) + ")");
            item.save(function ( err, i ) {
                if (err) {
                    logger.error("mongoAdapter.saveItem error(" + JSON.stringify( err ) + ")");
                    d.reject("mongoAdapter.saveItem Error:"+err);
                }
                else    {
                    logger.debug("mongoAdapter.saveItem saved(" + JSON.stringify( i ) + ")");
                    d.resolve(  extend({},  afterRead.item(i)) );
                }
                //return (err) ?  : d.resolve(  extend({},  afterRead.item(i)) );
            });
        });
        return d.promise;
    };

    this.getItem = function (itemId) {
        var d = q.defer();
        model.Item.findOne({id: itemId})
            .populate('relationships')
            .exec(function (err, itm) {
                (err) ? d.reject(err) : d.resolve(afterRead.item(itm));
            });
        return d.promise;
    };

    this.findItems = function (criteria) {
        var d = q.defer();
        logger.debug("mongoAdapter.findItems(" + JSON.stringify( criteria ) + ")");
        model.Item.find(criteria)
            .populate('relationships')
            .exec(function (err, itms) {
                if(err)
                    logger.error("mongoAdapter.findItems(" + JSON.stringify( criteria ) + ") - Failed: " + err );
                else
                    logger.debug("mongoAdapter.findItems(" + JSON.stringify( criteria ) + ") = "+JSON.stringify(itms));
                (err) ? d.reject(err) : d.resolve(itms.map(afterRead.item));
            });
        return d.promise;
    };

    this.getItems = function ( ) {
        var d = q.defer();
//        f = callbackWithReport("mongoAdapter.getItems()", f);
        model.Item.find({})
            .populate('relationships')
            .exec(function (err, itms) {
                (err) ? d.reject(err) : d.resolve(itms.map(afterRead.item));
            });
        return d.promise;
    };
    this.deleteItem = function (itemId) {
        var d= q.defer();
        model.Item.findOne({id: itemId}).remove(function(err,res){
            return (err) ? d.reject(err) : d.resolve(true);
        });
        return d.promise;
    };

    /*
     */

    function createQueryObject(searchText, searchOptions) {
        // TODO: Must add code to create the qry object for the
        // TODO: searchText and options
    }

    this.findItemsWithText = function (searchText, searchOptions) {
        var d = q.defer();
        var qry = createQueryObject(searchText, searchOptions);
        model.Item.find(qry)
            .populate('relationships')
            .exec(function (err, items) {
                (err) ? d.reject(err) : d.resolve(items.map(afterRead.itemType));
            });
        return d.promise;
    };

    //////  ViewItem  //////
    //////  ViewItem  //////
    this.getViewItem = function (vitemId) {
        var d = q.defer();
        var vi = model.ViewItem.findOne({id: vitemId})
            .populate('item')
            .exec(function (err, vitem) {
                return  (err) ? d.reject(err) : d.resolve(afterRead.viewItem(vitem));
            });
        return d.promise;
    };

    this.saveViewItem = function (vi) {
        var d = q.defer();
        vi = beforeSave.viewItem(vi);
        var vitem = new model.ViewItem(vi);
        vitem.save(function (err, vitem) {
            return  (err) ? d.reject(err) : d.resolve(afterRead.viewItem(vitem));
        });
        return d.promise;
    };

    this.createViewItem = function (viewId, item, position) {
        var d = q.defer();
        q.all([this.getView(viewId), this.saveItem(item)])
            .then( function ( a ) {
                var v = a[0];
                var i = a[1];
                var vi = {
                    viewId: viewId,
                    item: i,
                    position: position
                };
                var vitem = new model.ViewItem(vi);
                v.items.push(vitem);
                return this.saveView(v)
                    .then(function ( saved) {
                        return d.resolve(afterRead.viewItem(vi));
                    });
            })
            .catch(function(e){
                d.reject(e);
            });
        return d.promise;
    };

    this.updateViewItemPosition = function (vitemId, x, y) {
        var d= q.defer();
        getViewItem(vitemId).then( function ( vitem) {
            vitem.position.x = x;
            vitem.position.y = y;
            return self.saveViewItem(vitem, function (err, vi) {
                return  (err) ? d.reject(err) : d.resolve((vi));
            });
        })
            .catch(function(err){
                    d.reject(err);
            });
        return d.promise;
    };

    //////  Context  //////
    //////  Context  //////
    this.getContext = function (context, area) {
        var d = q.defer();
            model.Contexts.findOne({name: context, area: area})
                .exec(function (err, ctxt) {
                    (err) ? d.reject(err) : d.resolve(afterRead.context(ctxt));
                });
        return d.promise;

    };
    
    this.saveContext = function (context, area, types) {
        var d= q.defer();
//        f = callbackWithReport("mongoAdapter.saveContext(" + context + "," + area + "," + JSON.stringify(types) + ")", f);
        var ctxt = new model.Contexts({name: context, area: area, types: types });
        ctxt.save(function (err, c) {
            return  (err) ? d.reject(err) : d.resolve(afterRead.context(c));
        });
        return d.promise;
    };

    //////  View  //////
    //////  View  //////

    // get the full view
    this.getView = function (viewId) {
        var d = q.defer();
        logger.debug("mongoAdapter.getView(" + viewId + ")");
      //  viewId = new model.ObjectID(viewId);
        model.View.findOne({_id: viewId})
            .populate('summary')
            .populate('data')
            .exec(function (err, view){
                return  (err) ? d.reject(err) : d.resolve(afterRead.view(view));
            });
        return d.promise;
    };

    /**
     * Returns an Array of ViewSummary
     *
     * @returns {*|Function|Function|promise|promise|Q.promise}
     */
    this.getViews = function (){
        var d = q.defer();
        logger.debug("mongoAdapter.getViews()");
        model.View.find({})
            .populate('summary')
            .exec(function (err, views) {
               // logger.debug("mongoAdapter.getViews(): "+JSON.stringify(views));
                if(err) {
                    d.reject( err );
                    logger.error("mongoAdapter.getViews(): rejected: "+JSON.stringify(err));
                } else {
                    logger.debug("mongoAdapter.getViews(): resolved: 0 "+JSON.stringify(views));
                    var nuviews = views.map(function( vw ){return vw.summary;}).filter(identity).map(afterRead.viewSummary);
                    logger.debug("mongoAdapter.getViews(): resolved: 1 "+JSON.stringify(nuviews));
                    d.resolve( nuviews );
                }
            });
        return d.promise;
    };

    // getViews really returns the summaries so this is an alias
    this.getViewSummaries = this.getViews;


    /*
        View { Summary, Items, Options }
     */

    /**
     * Creates a new View w/ Summary and empty items
     *
     * @param viewP
     * @returns { Q.promise(View) }
     */
    this.createView = function (viewSummaryP){
        var d = q.defer();
        q.when(viewSummaryP, function(viewSummary){
            /*
            view should have : title, name, typeName,
            */

            // create the Summary and add it to View
            viewSummary = new model.ViewSummary({
                name: viewSummary.name,
                title: viewSummary.title,
                typeName: viewSummary.typeName,
                itemCount: viewSummary.itemCount
            });

            var view  = {};
            view.summary = viewSummary;
            // create the View
            var vw = new model.View(beforeSave.view(view));
            // add empty items
            vw.items = [];

            // add default Options
            vw.viewOptions = {};
            logger.debug("mongoAdapter.createView(" + JSON.stringify(view) + ")");
            vw.save(function (err, v) {
                if(!err){
                    v = afterRead.view(v);
                    view.id = v.id;
                    logger.debug("mongoAdapter.createView create&transform(" +  (v.id) + ")");
                    d.resolve(v);
                }
                else{
                    logger.error("mongoAdapter.createView() Error: (" + JSON.stringify(err) + ")" );
                    d.reject( err );
                }
            });
        });
        return d.promise;
    };

    this.saveView = function (viewP){
        var d = q.defer();
        q.when(viewP, function(view){
            logger.debug("mongoAdapter.saveView(" + JSON.stringify(view) + ")");
            var o = new model.View(beforeSave.view(view));
            o.save(function (err, v) {
                if(!err){
                    v = afterRead.view( v );
                    logger.debug("mongoAdapter.saveView saved&transform(" + (v.id) + ")");
                    d.resolve(v);
                }
                else{
                    logger.error("mongoAdapter.saveView() Error: (" + JSON.stringify(err) + ")" );
                    d.reject( err );
                }
            });
        });
        return d.promise;
    };

    this.updateView = function (view ) {
        var d = q.defer();
        logger.debug("mongoAdapter.updateView(" + JSON.stringify(view) + ")");
        var o = new model.View(beforeSave.view(view));
        o.save(function (err, v) {
            return  (err) ? d.reject(err) : d.resolve(afterRead.view(v));
        });
    };

    this.updateViewOptions = function (viewId, viewOptions) {
        var d = q.defer();
        model.ViewSummary.findOne({_id: viewId}, function(err, doc){
            if(err){
                d.reject(err);
            }
            else{
                doc.viewOptions = viewOptions;
                doc.save(function(err){
                    if (err){
                        d.reject(err);
                    }
                    else
                        d.resolve(doc);
                });
            }
        });
        return d.promise;
    };

    this.updateViewSummary = function (viewId, summary) {
        var d = q.defer();
        model.ViewSummary.findOne({_id: viewId}, function(err, doc){
            if(err){
                d.reject(err);
            }
            else{
                summary.viewId = viewId;/// just in case
                doc.summary = summary;
                doc.save(function(err){
                    if (err){
                        d.reject(err);
                    }
                    else
                        d.resolve(doc);
                });
            }
        });
        return d.promise;
    };
    this.updateViewItems = function (viewId, viewItems) {
        var d = q.defer();
        model.View.findOne({_id: viewId}, function(err, doc){
            if(err){
                console.error("mongoAdapter.updateViewItems(view:"+viewId+") Could not find view!");
                d.reject(err);
            }
            else{
                doc.data = doc.data || {};
                doc.data.items = viewItems;/// replaces the viewItems
                doc.save(function(err){
                    if (err){
                        console.error("mongoAdapter.updateViewItems(view:"+viewId+") Could not update items: "+JSON.stringify(err));
                        d.reject(err);
                    }
                    else
                        console.log("mongoAdapter.updateViewItems(view:"+viewId+") updated items: "+JSON.stringify(doc.data.items))
                        d.resolve(doc);
                });
            }
        });
        return d.promise;
    };

    /////////// EXPORTS ////////////
    /////////// EXPORTS ////////////

    exports.saveCategory = (this.saveCategory);
    exports.deleteCategory = (this.deleteCategory);
    exports.getCategory = (this.getCategory);
    exports.getCategories = (this.getCategories);

    exports.saveRelationshipType = (this.saveRelationshipType);
    exports.updateRelationshipType = (this.updateRelationshipType);
    exports.getRelationshipType = (this.getRelationshipType);
    exports.getRelationshipTypes = (this.getRelationshipTypes);
    exports.getRelationshipTypeById = (this.getRelationshipTypeById);

    exports.saveRelationship = (this.saveRelationship);;
    exports.getRelationship = (this.getRelationship);;

    exports.saveItemType =  (this.saveItemType);
    exports.getItemType = (this.getItemType);
    exports.updateItemType = (this.updateItemType);
    exports.getItemTypes = (this.getItemTypes);
    exports.getItemTypeById =  (this.getItemTypeById);
    exports.getItemTypeByName = (this.getItemTypeByName);

    exports.findItems = (this.findItems);
    exports.findItemsWithText = (this.findItemsWithText);
    exports.saveItem = (this.saveItem);
    exports.getItems = (this.getItems);
    exports.getItem = (this.getItem);
    exports.deleteItem = (this.deleteItem);

    exports.saveViewItem = (this.saveViewItem);
    exports.getViewItem = (this.getViewItem);
    exports.updateViewItemPosition = (this.updateViewItemPosition);
    exports.updateViewItems = (this.updateViewItems);

    exports.saveViewType = (this.saveViewType);
    exports.getViewType = (this.getViewType);
    exports.getViewTypes = (this.getViewTypes);

    exports.createView = (this.createView);
    exports.getView = (this.getView);
    exports.saveView = (this.saveView);
    exports.getViews = (this.getViews);
    exports.updateViewOptions = (this.updateViewOptions);
    exports.updateViewItems = (this.updateViewItems);
    exports.updateViewSummary = (this.updateViewSummary);

    exports.getContext = (this.getContext);
    exports.saveContext = (this.saveContext);

})(require('wu').wu, require('mongoose'),
        require("./model.js"), require("xtend"),
        require('./logger.js'),
        require('q'));
