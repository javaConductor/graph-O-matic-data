/**
 * Created with JetBrains WebStorm.
 * User: lee
 * Date: 6/20/13
 * Time: 1:58 PM
 */

(function (mongoose, model, extend, logger) {

	this.debug = function(txt){ txt = txt || ""; logger.debug("Debug: "+ txt);}
	this.log = logger.debug;
	this.error = logger.error;


	var self= this;
	this.callbackWithReport= function(label, f){
		return function(err, data){
			if (err || !data){
				logger.error(
					"\nCall to "+label+" returned error >>\n" + JSON.stringify(err, null, '    \n')
				);
			}
			else
				logger.debug(
					"\nCall to "+label+" returned >>\n"+
					JSON.stringify(data, null, '\t')
				);
			f( err, data );
			//self.log("");
		}
	};

	//////  Relationship Category //////
	//////  Relationship Category //////
	this.saveRelationshipCategory = function(rcat, f){
		f= callbackWithReport("mongoAdapter.saveRelationshipCategory("+JSON.stringify(rcat)+")",f);
			var relCat = new model.RelationshipTypeCategory(rcat);
			relCat.save( f );
	};

	this.getRelationshipCategories = function( f ){
		f= callbackWithReport("mongoAdapter.getRelationshipCategories()",f);

		model.RelationshipTypeCategory
		  .find({})
		  .exec(function(err, relCats){
			  return  (err) ? f ( err, null ) : f(null, relCats);
		  });
	};


	////////  Relationship Type ////////
	////////  Relationship Type ////////
	this.saveRelationshipType = function(rtype, f){
		f = callbackWithReport("mongoAdapter.saveRelationshipType("+ JSON.stringify( rtype)+")",f);
		var relType = new model.RelationshipType(rtype);
		relType.save( f );
	};

	this.updateRelationshipType = function(rtype, f){
		f = callbackWithReport("mongoAdapter.updateRelationshipType("+ JSON.stringify( rtype)+")", f );
		logger.debug("mongoAdapter.updateRelationshipType("+ JSON.stringify( rtype)+")");

		var o = rtype.toObject();
		delete o['_id'];
		//o = extend({}, o);rtype.save(f)
		model.RelationshipType.findOneAndUpdate( { _id: rtype._id }, o, {new: false})
		  .populate('parent')
		  .exec(function(err, rt){
			 // console.dir(["updateRelationshipType(): Error: >>", err ? JSON.stringify(err) : "NONE"]);
			return (err) ? f(err) : f( null, rt);
		} );
	};

	this.getRelationshipTypeById = function(rtypeId, f){
		f = callbackWithReport("mongoAdapter.getRelationshipTypeById("+JSON.stringify(rtypeId)+")",f);
		var rt  = model.RelationshipType.findOne({id: rtypeId})
		  .populate('parent')
		  .populate('category')
		  .populate('reciprocalRelationship')
		  .exec(function(err, rtype){
			  return  (err) ? f ( err, null ) : f(null, rtype);
		  })
	};

	this.getRelationshipType = function(context, area, name, f){
		f = callbackWithReport("mongoAdapter.getRelationshipType("+context+"."+area+"."+name+")",f);
		var rt  = model.RelationshipType.findOne({name: name, 'origin.context':context, 'origin.area':area})
		  .populate('parent')
		  .populate('category')
		  .populate('reciprocalRelationship')
		  .exec(function(err, rtype){
			  return  (err) ? f ( err, null ) : f(null, rtype);
		  })
	};

	this.getRelationshipTypes = function( f ){
		f= callbackWithReport("mongoAdapter.getRelationshipTypes()", f );
		var rt  = model.RelationshipType.find({})
		  .populate('parent')
		  .populate('category')
		  .populate('reciprocalRelationship')
		  .exec(function(err, rtypes){
			  return  (err) ? f ( err, null ) : f(null, rtypes);
		  })
	};

	//////  Item Category //////
	//////  Item Category //////
	this.saveItemCategory = function(icat, f){
		f= callbackWithReport("mongoAdapter.saveItemCategory("+JSON.stringify(icat)+")",f);
		var itemCat = new model.ItemTypeCategory(icat);
		itemCat.save( function(err, saved){
			err ? f(err) : f(null, saved);
		} );
	};

	this.getItemCategory = function(icatId, f){
		f = callbackWithReport("mongoAdapter.getItemCategory("+icatId.toString()+")",f);

		if (!icatId)
			return f("No ID.", null);

		model.ItemTypeCategory
		  .findOne({_id: (icatId)})
		  .exec(function(err, iCat){
			  return  (err) ? f ( err, null ) : f(null, iCat);
		  });
	};

	this.getItemCategories = function( f ){
		f= callbackWithReport("mongoAdapter.getItemCategories()",f);
		model.ItemTypeCategory
		  .find({})
		  .exec(function(err, iCats){
			  return  (err) ? f ( err, null ) : f(null, iCats);
		  });
	};

	//////  ItemType  //////
	//////  ItemType  //////
	this.saveItemType = function(it, f){
		f= callbackWithReport("mongoAdapter.saveItemType("+JSON.stringify(it)+")", f);

		var itemType = new model.ItemType(it);
		itemType.save( function(err, saved){
			if(err){
				return f(err,null);
			}
			getItemTypeById(saved._id, f);//populate the stuff
		} );
	};



	this.updateItemType = function(itype, f){
		f = callbackWithReport("mongoAdapter.updateItemType("+ JSON.stringify( itype )+")", f );
		logger.debug("mongoAdapter.updateItemType("+ JSON.stringify( itype )+")");

//		if ( f != null)
		return itype.save(f);
//
//		var o = itype.toObject();
//		delete o['_id'];
//		model.ItemType.findOneAndUpdate( { _id: itype._id }, o, {new: false})
//		  .populate('parent')
//		  .exec(function(err, it){
//			//  if (err)
//			  console.dir(["updateItemType(): Error: >>", err]);
//			  return (err) ? f(err) : f( null, it);
//		  } );
	};

	this.getItemTypeById = function(itypeId, f){
		f= callbackWithReport("mongoAdapter.getItemTypeById("+itypeId.toString()+")",f);
		model.ItemType.findOne({_id:( itypeId)})
		  .populate('category')
		  .populate('properties.itemTypes')
		  .populate('properties.relationshipTypes')
		  .exec(f);
	};

	this.getItemType = function(context, area, name, f){
		f= callbackWithReport("mongoAdapter.getItemType("+context+"."+area+"."+name+")",f);
		model.ItemType.findOne({'origin.context': context, 'origin.area': area, name: name})
		  .populate('category')
		  .populate('parent')
		  .populate('properties.itemTypes')
		  .populate('properties.relationshipTypes')
		  .exec(function(err, itype){
			  (err) ? f(err) : f( null, itype );
		  });
	};

	this.getItemTypes = function(f){
		f= callbackWithReport("mongoAdapter.getItemTypes()",f);
		model.ItemType.find({})
		  .populate('category')
		  .exec(f);
	};

	//////  Item  //////
	//////  Item  //////
	this.saveItem = function(itm, f){
		f= callbackWithReport("mongoAdapter.saveItem("+JSON.stringify(itm)+")",f);
		var item = new model.Item(itm);
		item.save( f );
	};

	this.getItem = function(itemId, f){
		f= callbackWithReport("mongoAdapter.getItem("+itemId.toString()+")",f);
		model.Item.findOne({id:itemId})
		  .populate('type')
		  .populate('relationships')
		  .exec(f);
	};

	//////  ViewItem  //////
	//////  ViewItem  //////
	this.getViewItem = function( vitemId, f ){
		f= callbackWithReport("mongoAdapter.getViewItem("+vitemId.toString()+")",f);
		var vi  = model.ViewItem.findOne({id: vitemId})
		  .populate('item')
		  .exec(function(err, vitem){
			  return  (err) ? f ( err, null ) : f(null, vitem);
		  })
	};

	this.saveViewItem = function( vi, f ){
		f= callbackWithReport("mongoAdapter.saveViewItem("+JSON.stringify(vi)+")",f);
		var vitem = new model.ViewItem(vi);
		vitem.save( f );
	};

	this.updateViewItemPosition = function( vitemId, x, y ,f ){
		f= callbackWithReport("mongoAdapter.updateViewItemPosition("+vitemId.toString()+","+x+","+y+")");
		getViewItem(vitemId, function(err, vitem){
			if(err)
				return f(err,null);
			vitem.position.x = x;
			vitem.position.y = y;
			return self.saveViewItem(vitem, f);
		})

	};

	//////  Context  //////
	//////  Context  //////
	this.getContext = function( context, area, f ){
		f= callbackWithReport("mongoAdapter.getContext("+context+","+area+")",f);
		model.Contexts.findOne({name: context, area: area})
		  .exec(function(err, ctxt){
			  (err) ? f ( err, null ) : f(null, ctxt);
		  })
	};

	this.saveContext = function( context, area, types, f ){
		f= callbackWithReport("mongoAdapter.saveContext(" + context + "," + area + "," + JSON.stringify( types ) + ")", f);
		var ctxt = new model.Contexts( {name: context, area: area, types: types } );
		ctxt.save( f );
	};

	/////////// EXPORTS ////////////
	/////////// EXPORTS ////////////

	exports.saveRelationshipCategory = this.saveRelationshipCategory;
	exports.getRelationshipCategories = this.getRelationshipCategories;

	exports.saveItemCategory = this.saveItemCategory;
	exports.getItemCategory = this.getItemCategory;
	exports.getItemCategories = this.getItemCategories;

	exports.saveRelationshipType = this.saveRelationshipType;
	exports.updateRelationshipType = this.updateRelationshipType;
	exports.getRelationshipType = this.getRelationshipType;
	exports.getRelationshipTypes = this.getRelationshipTypes;
	exports.getRelationshipTypeById = this.getRelationshipTypeById;

	exports.saveRelationship = this.saveRelationship;
	exports.getRelationship = this.getRelationship;

	exports.saveItemType = this.saveItemType;
	exports.getItemType = this.getItemType;
	exports.updateItemType = this.updateItemType;
	exports.getItemTypes = this.getItemTypes;
	exports.getItemTypeById = this.getItemTypeById;

	exports.saveItem = this.saveItem;
	exports.getItem = this.getItem;

	exports.saveViewItem = this.saveViewItem;
	exports.getViewItem = this.getViewItem;
	exports.updateViewItemPosition = this.updateViewItemPosition;

	exports.saveView = this.saveView;
	exports.getView = this.getView;

	exports.getContext = this.getContext;
	exports.saveContext = this.saveContext;

})(require('mongoose'),require("./model.js"), require("xtend"), require('./logger.js'));
